import logging
import os
import sqlite3
import time
import threading
import signal
import asyncio
from flask import Flask
from telegram import Update
from telegram.ext import Application, MessageHandler, filters, ContextTypes
from PIL import Image
import imagehash

# –ü—Ä–æ—Å—Ç–æ–π –≤–µ–±-—Å–µ—Ä–≤–µ—Ä –¥–ª—è Render
app_flask = Flask(__name__)

@app_flask.route('/')
def home():
    return "‚úÖ Bot is running!"

def run_flask():
    app_flask.run(host='0.0.0.0', port=5000)

# –ó–∞–ø—É—Å–∫–∞–µ–º Flask –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–º –ø–æ—Ç–æ–∫–µ
flask_thread = threading.Thread(target=run_flask, daemon=True)
flask_thread.start()

# –ü–æ–ª—É—á–∞–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∏–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è
TOKEN = os.getenv("BOT_TOKEN")
ADMIN_USER_ID = int(os.getenv("ADMIN_USER_ID", "0"))
DB_FILE = "photos.db"

# –î–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –∞–ª—å–±–æ–º–æ–≤
album_photo_count = {}

def init_db():
    conn = sqlite3.connect(DB_FILE)
    cursor = conn.cursor()
    cursor.execute("CREATE TABLE IF NOT EXISTS hashes (hash TEXT PRIMARY KEY)")
    conn.commit()
    conn.close()
    logging.info("‚úÖ –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞")

def hash_exists(img_hash):
    conn = sqlite3.connect(DB_FILE)
    cursor = conn.cursor()
    cursor.execute("SELECT 1 FROM hashes WHERE hash = ?", (img_hash,))
    result = cursor.fetchone() is not None
    conn.close()
    return result

def save_hash(img_hash):
    conn = sqlite3.connect(DB_FILE)
    cursor = conn.cursor()
    try:
        cursor.execute("INSERT INTO hashes (hash) VALUES (?)", (img_hash,))
        conn.commit()
        logging.info(f"üíæ –•–µ—à —Å–æ—Ö—Ä–∞–Ω–µ–Ω –≤ –ë–î: {img_hash}")
    except sqlite3.IntegrityError:
        logging.info(f"‚ö†Ô∏è –•–µ—à —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç: {img_hash}")
        pass
    except Exception as e:
        logging.error(f"‚ùå –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Ö–µ—à–∞: {e}")
    finally:
        conn.close()

async def check_photos_limit(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–∏–º–∏—Ç–∞ —Ñ–æ—Ç–æ –≤ –ê–õ–¨–ë–û–ú–ê–•"""
    user = update.effective_user
    message = update.message
    
    if user.id == ADMIN_USER_ID or not message or not message.photo:
        return
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–æ–ª—å–∫–æ –ê–õ–¨–ë–û–ú–´ (–≥—Ä—É–ø–ø—ã —Ñ–æ—Ç–æ)
    if message.media_group_id:
        album_id = message.media_group_id
        
        # –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º —Å—á–µ—Ç—á–∏–∫ —Ñ–æ—Ç–æ –≤ –∞–ª—å–±–æ–º–µ
        if album_id not in album_photo_count:
            album_photo_count[album_id] = 1
        else:
            album_photo_count[album_id] += 1
        
        # –ï—Å–ª–∏ –≤ –∞–ª—å–±–æ–º–µ –±–æ–ª—å—à–µ 2 —Ñ–æ—Ç–æ - –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–∞–µ–º
        if album_photo_count[album_id] > 2:
            warning = "üì∏ –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è–π—Ç–µ –±–æ–ª—å—à–µ 2 —Ñ–æ—Ç–æ –≤ –æ–¥–Ω–æ–º —Å–æ–æ–±—â–µ–Ω–∏–∏! –û–∑–Ω–∞–∫–æ–º—å—Ç–µ—Å—å —Å –ø—Ä–∞–≤–∏–ª–∞–º–∏ –≤ –∑–∞–∫—Ä–µ–ø–ª—ë–Ω–Ω–æ–º —Å–æ–æ–±—â–µ–Ω–∏–∏."
            await message.reply_text(warning, reply_to_message_id=message.message_id)
            
            # –û—á–∏—â–∞–µ–º —Å—á–µ—Ç—á–∏–∫ –¥–ª—è —ç—Ç–æ–≥–æ –∞–ª—å–±–æ–º–∞
            album_photo_count[album_id] = -100  # –ß—Ç–æ–±—ã –Ω–µ —Å–ø–∞–º–∏—Ç—å

async def handle_photo(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Ñ–æ—Ç–æ"""
    user = update.effective_user
    message = update.message

    # –°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–≤–µ—Ä—è–µ–º –ª–∏–º–∏—Ç —Ñ–æ—Ç–æ
    await check_photos_limit(update, context)
    
    # –ó–∞—Ç–µ–º –ø—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞ –¥—É–±–ª–∏–∫–∞—Ç—ã
    if user.id == ADMIN_USER_ID:
        logging.info("üëë –°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç –∞–¥–º–∏–Ω–∞ - –ø—Ä–æ–ø—É—Å–∫–∞–µ–º")
        return

    if not message or not message.photo:
        return

    photo = message.photo[-1]
    file = await context.bot.get_file(photo.file_id)
    file_path = f"temp_{photo.file_id}.jpg"
    await file.download_to_drive(file_path)

    try:
        image = Image.open(file_path)
        img_hash = str(imagehash.average_hash(image))
        
        logging.info(f"üîç –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–æ—Ç–æ, —Ö–µ—à: {img_hash}")

        # –î–ò–ê–ì–ù–û–°–¢–ò–ö–ê: –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç hash_exists
        exists = hash_exists(img_hash)
        logging.info(f"üìä –•–µ—à {img_hash} —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –≤ –ë–î: {exists}")

        if exists:
            mention = f"@{user.username}" if user.username else f"[{user.first_name}](tg://user?id={user.id})"
            logging.info(f"üö® –ù–∞–π–¥–µ–Ω –¥—É–±–ª–∏–∫–∞—Ç! –£–¥–∞–ª—è—é —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç {mention}")
            
            await update.effective_chat.send_message(
                text=f"‚ö†Ô∏è {mention}, —ç—Ç–æ —Ñ–æ—Ç–æ —É–∂–µ –±—ã–ª–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ —Ä–∞–Ω–µ–µ!",
                reply_to_message_id=message.message_id,
                parse_mode="Markdown"
            )
            await message.delete()
            logging.info("‚úÖ –î—É–±–ª–∏–∫–∞—Ç —É–¥–∞–ª–µ–Ω")
        else:
            save_hash(img_hash)
            logging.info(f"üíæ –°–æ—Ö—Ä–∞–Ω–µ–Ω –Ω–æ–≤—ã–π —Ö–µ—à: {img_hash}")

    except Exception as e:
        logging.error(f"–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Ñ–æ—Ç–æ: {e}")
    finally:
        if os.path.exists(file_path):
            os.remove(file_path)

async def error_handler(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ—à–∏–±–æ–∫"""
    logging.error(f"–û—à–∏–±–∫–∞: {context.error}")

def main():
    if not TOKEN:
        raise RuntimeError("‚ùå –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è BOT_TOKEN –Ω–µ –∑–∞–¥–∞–Ω–∞!")

    logging.basicConfig(
        level=logging.INFO,
        format='%(asctime)s - %(levelname)s - %(message)s'
    )
    
    init_db()

    app = Application.builder().token(TOKEN).build()
    app.add_handler(MessageHandler(filters.PHOTO, handle_photo))
    app.add_error_handler(error_handler)

    # Graceful shutdown –¥–ª—è Render
    def signal_handler(signum, frame):
        logging.info("üö™ –ü–æ–ª—É—á–µ–Ω —Å–∏–≥–Ω–∞–ª –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è...")
        app.stop()
        logging.info("‚úÖ –ë–æ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –∑–∞–≤–µ—Ä—à–∏–ª —Ä–∞–±–æ—Ç—É")
        os._exit(0)

    signal.signal(signal.SIGTERM, signal_handler)
    signal.signal(signal.SIGINT, signal_handler)

    logging.info("‚úÖ –ë–æ—Ç –∑–∞–ø—É—â–µ–Ω - –ø—Ä–æ–≤–µ—Ä—è–µ—Ç —Ç–æ–ª—å–∫–æ –∞–ª—å–±–æ–º—ã –∏ –¥—É–±–ª–∏–∫–∞—Ç—ã")
    
    try:
        app.run_polling()
    except Exception as e:
        logging.error(f"–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞: {e}")
        os._exit(1)

if __name__ == "__main__":
    main()
